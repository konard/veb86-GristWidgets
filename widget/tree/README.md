# Виджет "Дерево иерархии устройств" для Grist

## Описание

Управляющий виджет для построения иерархического дерева устройств из таблицы с возможностью фильтрации данных в связанных табличных виджетах.

## Основные возможности

### 1. Построение иерархии устройств

- **Фильтрация по флагу**: Включаются только устройства с `icanbeheadunit = -1` (**ИСПРАВЛЕНО**: ранее было `= 1`)
- **Алгоритм**: Построение на основе ссылок родитель-ребенок через поле `HeadDeviceName`
- **Корневые элементы**: Автоматическое определение устройств без родителей
- **Защита от циклов**: Обработка циклических ссылок

### 2. Настраиваемая конфигурация

Доступна панель настроек (кнопка ⚙️ в правом верхнем углу):

- **Поле ID устройства** (по умолчанию: `NMO_BaseName`)
- **Поле родителя** (по умолчанию: `HeadDeviceName`)
- **Поле флага иерархии** (по умолчанию: `icanbeheadunit`)
- **Поле отображения** (по умолчанию: `NMO_BaseName`)

### 3. Фильтрация связанных виджетов

При выборе узла в дереве:
- Применяется фильтр к связанным табличным виджетам
- Фильтруются выбранное устройство и **все его потомки рекурсивно**
- Для корневого элемента - все устройства в поддереве
- Для листового узла - только выбранное устройство

### 4. Интерфейс пользователя

- **Древовидная структура** с иконками для папок и файлов
- **Автоматическое раскрытие** всех узлов по умолчанию
- **Компактная кнопка настроек** - только иконка шестеренки
- **Статус-бар** с информацией о состоянии
- **Индикатор загрузки** при обработке данных

### 5. Обработка состояний

- **"Загрузка данных..."** - при получении данных из Grist
- **"Нет данных для отображения"** - если таблица пуста
- **"Нет устройств с флагом..."** - если нет устройств с `icanbeheadunit = -1`
- **Сообщения об ошибках** - при проблемах с данными

## Архитектура кода

Реализация следует стандартам кодирования из CLAUDE.md:

### Модульная структура

Код полностью разделен на отдельные модули для лучшей читаемости и поддерживаемости:

#### 1. **config.js** - Управление конфигурацией
- Хранение настроек полей
- Синхронизация с UI
- Валидация параметров
- **ИСПРАВЛЕНИЕ**: Значение флага изменено с 1 на -1

#### 2. **grist-api.js** - Работа с Grist API
- Загрузка данных из Grist
- Преобразование формата данных
- Навигация по записям
- Применение фильтров
- Подписка на события изменения данных

#### 3. **hierarchy.js** - Построение иерархии
- Фильтрация по флагу (`icanbeheadunit = -1`)
- Создание карты узлов
- Установка связей родитель-ребенок
- Поиск корневых элементов
- Обработка циклических ссылок
- Рекурсивный сбор всех потомков

#### 4. **ui.js** - Отображение интерфейса
- Инициализация дерева jsTree
- Обновление дерева
- Обработка выбора узлов
- Управление статус-баром
- Управление панелью настроек

#### 5. **app.js** - Главный контроллер
- Инициализация приложения
- Координация модулей
- Обработка событий
- Управление жизненным циклом

#### 6. **css/style.css** - Стили
- Все CSS вынесено в отдельный файл
- Логическое разделение на блоки
- Подробные комментарии на русском языке

### Принципы реализации

- ✅ Модули не превышают 300 строк
- ✅ Каждый модуль имеет одну чёткую ответственность
- ✅ Функции не превышают 30 строк
- ✅ Все комментарии на русском языке
- ✅ JSDoc для всех функций
- ✅ Отсутствие магических чисел (все константы именованы)
- ✅ DRY (Don't Repeat Yourself)
- ✅ Модульная архитектура с чистым разделением слоев

## Структура проекта

```
widget/tree/
├── index.html          # Главный HTML файл
├── grist-plugin-api.js # Grist Plugin API
├── README.md           # Документация
├── css/
│   └── style.css       # Стили виджета
└── js/
    ├── config.js       # Модуль конфигурации
    ├── grist-api.js    # Модуль взаимодействия с Grist
    ├── hierarchy.js    # Модуль построения иерархии
    ├── ui.js           # Модуль пользовательского интерфейса
    └── app.js          # Главный модуль приложения
```

## Структура данных

### Требуемые поля таблицы Device

```
NMO_BaseName      - Идентификатор устройства (строка)
HeadDeviceName    - Ссылка на родительское устройство (строка, значение из NMO_BaseName родителя)
icanbeheadunit    - Флаг участия в иерархии (-1 для участия, 0 для исключения)
```

### Пример данных

| id | NMO_BaseName | HeadDeviceName | icanbeheadunit |
|----|--------------|----------------|----------------|
| 1  | Device_A     | NULL           | -1             |
| 2  | Device_B     | Device_A       | -1             |
| 3  | Device_C     | Device_A       | -1             |
| 4  | Device_D     | Device_B       | -1             |
| 5  | Device_E     | Device_C       | 0              |

В этом примере:
- `Device_A` - корневой элемент
- `Device_B` и `Device_C` - дочерние для `Device_A`
- `Device_D` - дочерний для `Device_B`
- `Device_E` - не участвует в иерархии (icanbeheadunit = 0)

## Использование

### 1. Запуск сервера

```bash
python server.py
```

Сервер запустится на `http://localhost:3333`

### 2. Добавление виджета в Grist

1. Откройте документ Grist
2. Добавьте новый Custom Widget
3. Укажите URL: `http://localhost:3333/tree/index.html`
4. Выберите таблицу "Device" (или вашу таблицу с устройствами)
5. Настройте поля через кнопку ⚙️ Настройки

### 3. Настройка фильтрации

1. Добавьте табличные виджеты, которые нужно фильтровать
2. Настройте их для использования той же таблицы
3. При выборе узла в дереве фильтры применятся автоматически

## Технические детали

### Используемые библиотеки

- **jQuery 3.6.0** - DOM манипуляции
- **jsTree 3.3.12** - визуализация дерева
- **Grist Plugin API** - интеграция с Grist

### API Grist

```javascript
// Инициализация
grist.ready({ requiredAccess: 'read table' })

// Загрузка данных
grist.docApi.fetchSelectedTable()

// Навигация к записи
grist.setCursorPos({ rowId: recordId })

// Применение фильтра
grist.setSelectedRows(arrayOfIds)

// Обновление при изменении данных
grist.onRecords(callback)
```

### Алгоритм построения иерархии

1. **Фильтрация**: Отбор записей с `icanbeheadunit = -1`
2. **Создание карты**: Создание объектов узлов по идентификаторам
3. **Связывание**: Установка связей родитель-ребенок по `HeadDeviceName`
4. **Поиск корней**: Определение узлов без родителей
5. **Проверка циклов**: DFS для обнаружения циклических ссылок
6. **Рендеринг**: Рекурсивное построение визуального дерева

### Обработка ошибок

- Валидация структуры данных
- Проверка наличия обязательных полей
- Защита от некорректных ссылок
- Graceful degradation при отсутствии данных

## Исправления в версии Issue #5

### Основное исправление
- **КРИТИЧНО**: Изменен флаг фильтрации с `icanbeheadunit = 1` на `icanbeheadunit = -1`
- Обновлена логика фильтрации в модуле `hierarchy.js`
- Обновлена конфигурация по умолчанию в модуле `config.js`

### Улучшения кода
- ✅ CSS вынесен в отдельный файл `css/style.css`
- ✅ JavaScript разделен на 5 модулей по ответственности
- ✅ Модуль взаимодействия с Grist API выделен отдельно
- ✅ Модуль построения иерархии изолирован
- ✅ Все функции снабжены подробными комментариями на русском языке
- ✅ Кнопка настроек уменьшена до иконки шестеренки
- ✅ Улучшена рекурсивная фильтрация потомков

### Логические улучшения
- Полная рекурсивная фильтрация всех потомков (не только прямых детей)
- Улучшенная обработка циклических ссылок
- Более понятная структура кода с четким разделением ответственности
- Добавлены константы вместо магических чисел
- Улучшена обработка ошибок и граничных случаев

## Примеры кастомизации

### Изменение полей по умолчанию

Отредактируйте константы в `js/config.js`:

```javascript
var DEFAULT_ID_FIELD = 'DeviceID';           // вместо NMO_BaseName
var DEFAULT_PARENT_FIELD = 'ParentDevice';   // вместо HeadDeviceName
var DEFAULT_FLAG_FIELD = 'IsActive';         // вместо icanbeheadunit
var DEFAULT_DISPLAY_FIELD = 'DeviceName';    // отдельное поле для отображения
```

### Изменение значения флага

Если нужно использовать другое значение флага, измените в `js/config.js`:

```javascript
var DEFAULT_FLAG_VALUE = 1; // или любое другое значение
```

## Ограничения и известные проблемы

1. **Глубокая рекурсия**: Для очень глубоких деревьев (>100 уровней) может потребоваться оптимизация
2. **Большие объёмы данных**: При >10000 узлов рекомендуется ленивая загрузка
3. **Однотабличная фильтрация**: Текущая версия фильтрует только таблицу, к которой подключен виджет

## Будущие улучшения

- [ ] Поиск по дереву
- [ ] Drag & drop для перестроения иерархии
- [ ] Контекстное меню узлов
- [ ] Экспорт дерева в различных форматах
- [ ] Кеширование для повышения производительности
- [ ] Настройка внешнего вида (темы, размер шрифта)
- [ ] Выбор таблицы для фильтрации (разные таблицы для дерева и фильтра)

## Лицензия

Проект распространяется в соответствии с лицензией основного репозитория veb86/GristWidgets.

## Авторы

- Исходная реализация: veb86
- Модульная архитектура и развитие функционала: Claude Sonnet 4.5 (AI ассистент)

## Контакты и поддержка

Для сообщений об ошибках и запросов новых функций используйте:
https://github.com/veb86/GristWidgets/issues
