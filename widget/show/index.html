<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>GRIST Debug</title>
  <script src="./grist-plugin-api.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    button { padding: 10px 16px; margin: 5px; cursor: pointer; }
    pre { background: #f5f5f5; padding: 10px; overflow: auto; }
  </style>
</head>
<body>

<h2>–û—Ç–ª–∞–¥–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ GRIST</h2>
<button id="listTablesBtn">üìã –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã</button>
<button id="checkAccessBtn">üîê –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø</button>
<div id="output"></div>

<script>
  const output = document.getElementById("output");
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Grist
  grist.ready({
    requiredAccess: 'full' // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø
  });

  // 1. –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
  document.getElementById("listTablesBtn").addEventListener("click", async () => {
    try {
      output.innerHTML = "<h3>–ó–∞–≥—Ä—É–∂–∞—é —Å–ø–∏—Å–æ–∫ —Ç–∞–±–ª–∏—Ü...</h3>";
      
      // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ
      const tables = await grist.docApi.listTables();
      
      output.innerHTML = `
        <h3>–ù–∞–π–¥–µ–Ω–æ —Ç–∞–±–ª–∏—Ü: ${tables.length}</h3>
        <pre>${JSON.stringify(tables, null, 2)}</pre>
        
        <h4>–ò–º–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü:</h4>
        <ul>
          ${tables.map(table => `<li><strong>${table.id}</strong> (${table.fields?.length || 0} –ø–æ–ª–µ–π)</li>`).join('')}
        </ul>
      `;
      
    } catch (error) {
      output.innerHTML = `<div style="color: red;">
        <h3>‚ùå –û—à–∏–±–∫–∞:</h3>
        <pre>${error.message}</pre>
      </div>`;
    }
  });

  // 2. –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Ç–∞–±–ª–∏—Ü–∞–º
  document.getElementById("checkAccessBtn").addEventListener("click", async () => {
    try {
      output.innerHTML = "<h3>–ü—Ä–æ–≤–µ—Ä—è—é –¥–æ—Å—Ç—É–ø –∫ —Ç–∞–±–ª–∏—Ü–∞–º...</h3>";
      
      // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
      const testTables = ['TableA', 'TableB', 'Table1', 'Table2', 'Data', 'Sheet1'];
      const results = [];
      
      for (const tableName of testTables) {
        try {
          const table = await grist.docApi.fetchTable(tableName);
          results.push({
            name: tableName,
            exists: !!table,
            fields: table ? Object.keys(table.fields || {}) : [],
            rowCount: table?.id?.length || 0
          });
        } catch (err) {
          results.push({
            name: tableName,
            exists: false,
            error: err.message
          });
        }
      }
      
      output.innerHTML = `
        <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏:</h3>
        <table border="1" cellpadding="8" style="border-collapse: collapse;">
          <tr style="background: #eee;">
            <th>–ò–º—è —Ç–∞–±–ª–∏—Ü—ã</th>
            <th>–°—É—â–µ—Å—Ç–≤—É–µ—Ç</th>
            <th>–ö–æ–ª-–≤–æ —Å—Ç—Ä–æ–∫</th>
            <th>–ü–æ–ª—è (—Å—Ç–æ–ª–±—Ü—ã)</th>
            <th>–û—à–∏–±–∫–∞</th>
          </tr>
          ${results.map(r => `
            <tr>
              <td><strong>${r.name}</strong></td>
              <td>${r.exists ? '‚úÖ –î–∞' : '‚ùå –ù–µ—Ç'}</td>
              <td>${r.rowCount || '-'}</td>
              <td>${r.fields?.join(', ') || '-'}</td>
              <td>${r.error || '-'}</td>
            </tr>
          `).join('')}
        </table>
      `;
      
    } catch (error) {
      output.innerHTML = `<div style="color: red;">
        <h3>‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏:</h3>
        <pre>${error.message}</pre>
      </div>`;
    }
  });

  // 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  window.addEventListener('load', async () => {
    try {
      const tables = await grist.docApi.listTables();
      output.innerHTML = `
        <div style="background: #e8f5e9; padding: 15px; border-radius: 5px;">
          <h3>üëã –í–∏–¥–∂–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω!</h3>
          <p>–î–æ—Å—Ç—É–ø–Ω–æ —Ç–∞–±–ª–∏—Ü: <strong>${tables.length}</strong></p>
          <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –¥–µ—Ç–∞–ª–∏</p>
        </div>
      `;
    } catch (error) {
      output.innerHTML = `
        <div style="background: #ffebee; padding: 15px; border-radius: 5px;">
          <h3>‚ö†Ô∏è –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞</h3>
          <p>${error.message}</p>
          <p>–í–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –≤–∏–¥–∂–µ—Ç—É</p>
        </div>
      `;
    }
  });
</script>

</body>
</html>